image: maven:3.6.1

pipelines:
  default:
    - step:
        name: maven clean
        caches:
          - maven
        script:
          - mvn clean
    
      clone:
      depth: full              

      definitions:
      caches:
        sonar: ~/.sonar/cache 
      steps:
        - step: &build-test-sonarcloud
            name: Build, test and analyze on SonarCloud
            caches:
              - maven
              - sonar
            script:
              - mvn -B org.jacoco:jacoco-maven-plugin:prepare-agent verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
            artifacts:
              - target/**
        - step: &build-test
            name: Build and test
            caches:
              - maven
            script:
              - mvn -B verify
            artifacts:
              - target/**
      pipelines:
      default:
        - step: *build-test
      branches:
        master:
          - step: *build-test-sonarcloud
      pull-requests:
        '**':
          - step: *build-test-sonarcloud

    - step:
        name: maven package
        caches:
          - maven
        script:
          - mvn package 
          - ls target/
    
    
   